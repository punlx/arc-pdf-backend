## тЮд┬аRun locally with DockerтАСCompose

```bash
# 1. clone + cd
$ git clone https://github.com/punlx/arc-pdf-backend.git

# 2. start everything
$ docker compose up --build
```

# ArcPDF Backend тАУ р╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ъ **v1** р╣Бр╕ер╕░ **v2**

> р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Щр╕╡р╣Йр╕нр╕Шр╕┤р╕Ър╕▓р╕в **р╕Др╕зр╕▓р╕бр╣Бр╕Хр╕Бр╕Хр╣Ир╕▓р╕Зр╕лр╕ер╕▒р╕Б** р╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕ЩтАп`v1` р╣Бр╕ер╕░тАп`v2` р╕Вр╕нр╕Зр╕Ър╕гр╕┤р╕Бр╕▓р╕гтАпFastAPI р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣М ArcPDF р╕Юр╕гр╣Йр╕нр╕бр╕кр╕гр╕╕р╕Ыр╣Ар╕лр╕Хр╕╕р╕Ьр╕ер╣Гр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Бр╕ер╕░р╕Ьр╕ер╕Бр╕гр╕░р╕Чр╕Ър╕Чр╕╡р╣Ир╕Хр╕▓р╕бр╕бр╕▓ р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╕Юр╕▒р╕Тр╕Щр╕▓┬а/┬ар╕Ьр╕╣р╣Йр╕гр╕╡р╕зр╕┤р╕зр╣Вр╕Др╣Йр╕Фр╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╣Бр╕ер╕░р╕зр╕▓р╕Зр╣Бр╕Ьр╕ЩтАпmigrationтАпр╣Др╕Фр╣Йр╕Зр╣Ир╕▓р╕вр╕Вр╕╢р╣Йр╕Щ

---

## ЁЯЧВя╕П р╕кр╕гр╕╕р╕Ыр╕Др╕зр╕▓р╕бр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕Зр╣Бр╕Ър╕Ър╕вр╣Ир╕н

| р╕лр╕бр╕зр╕Ф                | v1                                           | v2                                                               | р╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣Мр╕Чр╕╡р╣Ир╣Др╕Фр╣Й                                               |
| ------------------- | -------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------------------------------ |
| **CORS**            | р╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╕Чр╕╕р╕Б origin (`*`)                       | р╕ер╣Зр╕нр╕Б┬аorigin┬ар╣Гр╕лр╣Йр╣Ар╕Йр╕Юр╕▓р╕░┬а`localhost:5173`┬ар╣Бр╕ер╕░┬а`arc-pdf.onrender.com` | р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ┬аCSRF┬а& р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Вр╣Йр╕▓р╕бр╣Вр╕Фр╣Ар╕бр╕Щ             |
| **Session Model**   | `uploaded_files: List`┬ар╣Бр╕Кр╕гр╣Мр╣Др╕Яр╕ер╣Мр╕Чр╕╕р╕Бр╣Бр╕Кр╕Хр╕гр╣Ир╕зр╕бр╕Бр╕▒р╕Щ | `uploaded_files: Dict[chat_id, List]`┬ар╣Бр╕вр╕Бр╣Др╕Яр╕ер╣Мр╕Хр╕▓р╕б┬аsession         | р╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Ыр╕Щр╕Бр╕▒р╕Щр╕Вр╕нр╕Зр╣Др╕Яр╕ер╣М┬атАУ┬ар╣Бр╕Хр╣Ир╕ер╕░р╣Бр╕Кр╕Хр╣Ар╕лр╣Зр╕Щр╣Ар╕Йр╕Юр╕▓р╕░р╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╕Хр╕▒р╕зр╣Ар╕нр╕З        |
| **Memory Tracking** | р╣Др╕бр╣Ир╕бр╕╡р╣Ар╕зр╕ер╕▓р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕ер╣Ир╕▓р╕кр╕╕р╕Ф                        | ┬ар╣Ар╕Юр╕┤р╣Ир╕б┬а`chat_last_active`┬ар╣Бр╕ер╕░ `touch_chat()`                     | р╣Ар╕гр╕╡р╕вр╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Бр╕Кр╕Хр╕Хр╕▓р╕бр╕Бр╕┤р╕Ир╕Бр╕гр╕гр╕бр╕ер╣Ир╕▓р╕кр╕╕р╕Фр╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З                     |
| **р╕Вр╕Щр╕▓р╕Фр╣Др╕Яр╕ер╣М**        | р╣Др╕бр╣Ир╕Ир╕│р╕Бр╕▒р╕Ф                                     | р╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕╡р╣И┬а10┬аMB┬а(┬а`MAX_FILE_SIZE`┬а)                               | р╕ер╕Фр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╣Ир╕вр╕З┬аDoS┬ар╕Фр╣Йр╕зр╕вр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щ                            |
| **/api/upload**     | `POST`┬ар╕гр╕н┬а*body*┬а`files[]`┬ар╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ          | р╕гр╕▒р╕Ъ┬а`chat_id`┬ар╕Ьр╣Ир╕▓р╕Щ┬аquery┬аparam┬а(р╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣Ир╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡)      | р╣Бр╕Щр╕Ър╣Др╕Яр╕ер╣Мр╕Цр╕╣р╕Бр╕Ьр╕╣р╕Бр╕Бр╕▒р╕Ъ┬аsession┬ар╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣Ир╕Хр╣Йр╕Щ┬атАУ┬аfrontend┬ар╕гр╕░р╕Ър╕╕р╣Др╕Фр╣Йр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ |
| **/api/files**      | р╕Др╕╖р╕Щр╣Др╕Яр╕ер╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╕р╕Бр╣Бр╕Кр╕Х                         | р╕Хр╣Йр╕нр╕Зр╕кр╣Ир╕З┬а`chat_id`┬ар╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╢р╕Зр╣Др╕Яр╕ер╣Мр╕Вр╕нр╕Зр╣Бр╕Кр╕Хр╕Щр╕▒р╣Йр╕Щ р╣Ж                       | р╕Др╕зр╕▓р╕бр╣Ар╕Ыр╣Зр╕Щр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Вр╕нр╕Зр╣Бр╕Хр╣Ир╕ер╕░ session                              |
| **Endpoints р╣Ар╕Юр╕┤р╣Ир╕б** | тАУ                                            | `DELETE /api/files/{file_id}`┬ар╣Бр╕ер╕░┬а`DELETE /api/files`            | р╕ер╕Ър╣Др╕Яр╕ер╣Мр╕гр╕▓р╕вр╕Хр╕▒р╕з┬а/┬ар╕ер╕Ър╕вр╕Бр╕Кр╕╕р╕Фр╣Гр╕Щ┬аsession                             |
| **WebSocket**       | р╣Др╕бр╣Ир╣Бр╕вр╕Б┬аsession┬ар╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕кр╣Ир╕З┬а`chat_id`           | р╕кр╕гр╣Йр╕▓р╕З┬а`chat_id`┬ар╣Гр╕лр╕бр╣Ир╣Гр╕лр╣Йр╣Ар╕кр╕бр╕н┬а&┬ар╣Гр╕Кр╣Йр╣Др╕Яр╕ер╣Мр╣Ар╕Йр╕Юр╕▓р╕░┬аsession               | р╕Чр╕│р╕Зр╕▓р╕Щр╕гр╣Ир╕зр╕бр╕Бр╕▒р╕Ъ frontend р╕Чр╕╡р╣И multiтАСchat р╣Др╕Фр╣Йр╕кр╕бр╕Ър╕╣р╕гр╕Ур╣Мр╕Вр╕╢р╣Йр╕Щ          |
| **Reset Logic**     | `reset()` р╕ер╕Ър╣Ар╕Йр╕Юр╕▓р╕░┬аchat_history               | р╣Ар╕Юр╕┤р╣Ир╕б flag┬а`clear_files`┬ар╣Ар╕ер╕╖р╕нр╕Бр╕гр╕╡р╣Ар╕Лр╕Хр╣Др╕Яр╕ер╣Мр╕Фр╣Йр╕зр╕в                      | FullтАСreset р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╣Др╕Фр╣Йр╕Чр╕▒р╣Йр╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Бр╕ер╕░р╣Др╕Яр╕ер╣М                      |
| **Sorting Chats**   | р╣Др╕бр╣Ир╕Бр╕│р╕лр╕Щр╕Ф                                     | р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕б `last_active_time` (DESC)                               | UX┬ар╕Фр╕╡р╕Бр╕зр╣Ир╕▓ тАУ р╣Бр╕Кр╕Хр╕Чр╕╡р╣Ир╣Ар╕Юр╕┤р╣Ир╕Зр╕Др╕╕р╕вр╕Вр╕╢р╣Йр╕Щр╕Бр╣Ир╕нр╕Щ                           |
| **HTTP Status**     | 400┬ар╕Чр╕▒р╣Ир╕зр╣Др╕Ы                                   | р╣Гр╕Кр╣Й┬а`413`┬ар╕кр╕│р╕лр╕гр╕▒р╕Ър╣Др╕Яр╕ер╣Мр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щ                                     | р╕кр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕лр╕бр╕▓р╕в┬аRFC┬ар╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ                                      |

---

## ЁЯФН р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Гр╕Щ┬а`v2`

### 1┬а┬╖ SessionтАСaware Storage

- `MemoryStore.uploaded_files` р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Ар╕Ыр╣Зр╕Щ `Dict[str, List[fileMeta]]` р╣Бр╕вр╕Бр╣Др╕Яр╕ер╣Мр╕Хр╣Ир╕н┬а`chat_id`
- р╣Ар╕бр╕Чр╣Зр╕нр╕Фр╣Гр╕лр╕бр╣И:
  - `add_files(chat_id, files)` тАУ┬ар╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Др╕Яр╕ер╣Мр╕ер╕З┬аsession
  - `get_files(chat_id)` тАУ┬ар╕Фр╕╢р╕Зр╣Др╕Яр╕ер╣Мр╣Ар╕Йр╕Юр╕▓р╕░┬аsession
  - `delete_file()`┬а&┬а`clear_files()`┬атАУ┬ар╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Др╕Яр╕ер╣Мр╕гр╕▓р╕вр╕Хр╕▒р╕з/р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

### 2┬а┬╖ р╕Бр╕│р╕лр╕Щр╕Фр╕Вр╕нр╕Ър╣Ар╕Вр╕Х┬аCORS┬ар╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",
        "https://arc-pdf.onrender.com",
    ],
    ...
)
```

р╕ер╕Фр╕Юр╕╖р╣Йр╕Щр╕Ьр╕┤р╕зр╣Вр╕Ир╕бр╕Хр╕╡ р╣Вр╕Фр╕вр╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╣Ар╕Йр╕Юр╕▓р╕░р╣Вр╕Фр╣Ар╕бр╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Ир╕гр╕┤р╕Зр╕гр╕░р╕лр╕зр╣Ир╕▓р╕З┬аdev┬ар╣Бр╕ер╕░┬аprod

### 3┬а┬╖ Upload Endpoint р╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╕гр╕╣р╣Й┬аchat_id

- signature р╣Гр╕лр╕бр╣И: `POST /api/upload?chat_id=...`
- р╕Цр╣Йр╕▓┬а`chat_id`┬ар╕вр╕▒р╕Зр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕кр╕гр╣Йр╕▓р╕З р╕Ир╕░р╕кр╕гр╣Йр╕▓р╕З session р╣Гр╕лр╣Йр╕Бр╣Ир╕нр╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
- р╣Др╕Яр╕ер╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Цр╕╣р╕Бр╣Ар╕Бр╣Зр╕Ър╣Бр╕вр╕Бр╕Хр╕▓р╕б┬аsession р╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣Ир╣Бр╕гр╕Б р╕гр╕▒р╕Ър╕Ыр╕гр╕░р╕Бр╕▒р╕Щ isolation

### 4┬а┬╖ р╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Фр╕Вр╕Щр╕▓р╕Фр╣Др╕Яр╕ер╣М & р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Др╕Яр╕ер╣М

```python
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB
if len(content) > MAX_FILE_SIZE:
    raise HTTPException(413, "... exceeds 10 MB")
```

р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Ьр╕╣р╣Йр╣Гр╕Кр╣ЙтАпр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Вр╕Фр╕вр╣Др╕бр╣Ир╕Хр╕▒р╣Йр╕Зр╣Гр╕И р╣Бр╕ер╕░р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ DoS

### 5┬а┬╖ WebSocket Flow р╣Гр╕лр╕бр╣И (SessionтАСaware)

- р╕Цр╣Йр╕▓ payload р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕┬а`chat_id` тЖТ backend р╕кр╕гр╣Йр╕▓р╕З┬аsession р╣Гр╕лр╕бр╣Ир╣Гр╕лр╣Й
- р╣Гр╕Кр╣Й `memory.get_files(chat_id)` р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Др╕│р╕Хр╕нр╕Ър╕нр╕┤р╕Зр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣Мр╣Ар╕Йр╕Юр╕▓р╕░р╣Бр╕Кр╕Х
- р╕вр╕▒р╕Зр╕Др╕Зр╕кр╣Ир╕З `typing тЖТ chunk тЖТ complete` р╣Бр╕Хр╣Ир╕гр╕░р╕Ър╕╕┬а`chat_id`┬ар╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ

### 6┬а┬╖ р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕нр╕▒р╕Щр╕Фр╕▒р╕Ър╣Бр╕Кр╕Хр╕Хр╕▓р╕бр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕ер╣Ир╕▓р╕кр╕╕р╕Ф

-┬ар╣Ар╕Юр╕┤р╣Ир╕б `chat_last_active: Dict[chat_id, ISOTime]` -┬ар╣Ар╕гр╕╡р╕вр╕Б┬а`touch_chat(chat_id)` р╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣И frontтАСend р╣Ар╕Ыр╕┤р╕Фр╕лр╕Щр╣Йр╕▓р╕Хр╣Ир╕▓р╕Зр╣Бр╕Кр╕Хр╣Бр╕бр╣Йр╣Др╕бр╣Ир╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б -┬а`GET /api/chat` р╕Ир╕░┬а`sort`┬ар╕Хр╕▓р╕б `last_active_time DESC` р╣Ар╕Юр╕╖р╣Ир╕н UX р╕Чр╕╡р╣Ир╕Др╕╕р╣Йр╕Щр╣Ар╕Др╕в (р╕Др╕ер╣Йр╕▓р╕в Slack / Messenger)

### 7┬а┬╖ Endpoint р╕ер╕Ър╣Др╕Яр╕ер╣М

```
DELETE /api/files/{file_id}?chat_id=...
DELETE /api/files?chat_id=...        # р╕ер╕Ър╕лр╕бр╕Фр╣Гр╕Щр╣Бр╕Кр╕Хр╕Щр╕▒р╣Йр╕Щ
```

р╣Ар╕Ыр╕┤р╕Фр╕Чр╕▓р╕Зр╣Гр╕лр╣Й UI р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╕ер╕░р╣Др╕Яр╕ер╣Мр╕лр╕гр╕╖р╕нр╕вр╕Бр╕Кр╕╕р╕Фр╣Гр╕Щр╣Бр╕Хр╣Ир╕ер╕░ session р╣Др╕Фр╣Й

### 8┬а┬╖ Reset Endpoint р╕Чр╕╡р╣Ир╕вр╕╖р╕Фр╕лр╕вр╕╕р╣Ир╕Щр╕Вр╕╢р╣Йр╕Щ

- р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М `clear_files` р╕Кр╣Ир╕зр╕вр╣Ар╕ер╕╖р╕нр╕Бр╣Др╕Фр╣Йр╕зр╣Ир╕▓р╕Ир╕░р╕ер╕Ър╣Др╕Яр╕ер╣Мр╕Фр╣Йр╕зр╕вр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
- Full Reset (`chat_id=None`)тАптЖТ┬ар╕ер╣Йр╕▓р╕Зр╕Чр╕▒р╣Йр╕З┬аchat┬ар╣Бр╕ер╕░тАпfiles, р╕нр╕нр╕Б┬а`session_id`┬ар╣Гр╕лр╕бр╣И

---

## ЁЯФД р╕Др╕╣р╣Ир╕бр╕╖р╕н┬аMigration┬аFrontend

1. **р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М**
   - р╕Хр╣Йр╕нр╕Зр╣Гр╕кр╣И┬а`chat_id`┬ар╣Ар╕Ыр╣Зр╕Щ┬аquery string┬ар╣Ар╕Кр╣Ир╕Щ┬а`POST /api/upload?chat_id=<uuid>`
   - р╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕Кр╕Хр╣Гр╕лр╕бр╣Ир╣Др╕Фр╣Йр╕Ьр╣Ир╕▓р╕Щ┬а`/api/chat/create`┬ар╕Бр╣Ир╕нр╕Щр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф
2. **р╕Фр╕╢р╕Зр╕гр╕▓р╕вр╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣М**
   - р╣Ар╕гр╕╡р╕вр╕Б┬а`GET /api/files?chat_id=<uuid>`
3. **р╕ер╕Ър╣Др╕Яр╕ер╣М**
   - р╣Ар╕Юр╕┤р╣Ир╕бр╕Ыр╕╕р╣Ир╕бр╣Гр╕Щ UI тЖТ┬а`DELETE /api/files/{file_id}?chat_id=<uuid>`
4. **WebSocket**
   - р╣Гр╕кр╣И┬а`chat_id`┬ар╣Гр╕Щ payload р╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕З
   ```json
   { "question": "...", "chat_id": "..." }
   ```
5. **р╣Ар╕гр╕╡р╕вр╕Зр╕ер╕│р╕Фр╕▒р╕Ър╣Бр╕Кр╕Х**
   - р╣Гр╕Кр╣Йр╕Яр╕┤р╕ер╕Фр╣М┬а`last_active_time`┬ар╕Ир╕▓р╕Б┬а`GET /api/chat`┬ар╣Бр╕Чр╕Щ┬а`last_message_time`

---
